name: Deploy to AWS

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  # TF_STATE_BUCKET: hello-aws-app-terraform-state
  # TF_LOCK_TABLE: hello-aws-app-terraform-locks

jobs:
  # bootstrap:
  #   runs-on: ubuntu-latest
  #   outputs:
  #     bootstrap_needed: ${{ steps.check.outputs.needed }}

  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #         aws-region: ${{ env.AWS_REGION }}

  #     - name: Check if state bucket exists
  #       id: check
  #       run: |
  #         if aws s3api head-bucket --bucket "${{ env.TF_STATE_BUCKET }}" 2>/dev/null; then
  #           echo "needed=false" >> $GITHUB_OUTPUT
  #           echo "State bucket already exists, skipping bootstrap"
  #         else
  #           echo "needed=true" >> $GITHUB_OUTPUT
  #           echo "State bucket does not exist, will create"
  #         fi

  #     - name: Setup Terraform
  #       if: steps.check.outputs.needed == 'true'
  #       uses: hashicorp/setup-terraform@v3
  #       with:
  #         terraform_wrapper: false

  #     - name: Bootstrap state backend
  #       if: steps.check.outputs.needed == 'true'
  #       working-directory: terraform/bootstrap
  #       run: |
  #         terraform init
  #         terraform apply -auto-approve \
  #           -var="region=${{ env.AWS_REGION }}" \
  #           -var="state_bucket_name=${{ env.TF_STATE_BUCKET }}" \
  #           -var="lock_table_name=${{ env.TF_LOCK_TABLE }}"

  deploy:
    runs-on: ubuntu-latest
    # needs: bootstrap

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # - name: Setup Terraform
      #   uses: hashicorp/setup-terraform@v3
      #   with:
      #     terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Create ECR repositories
        working-directory: terraform
        run: |
          terraform apply -auto-approve -target=aws_ecr_repository.backend -target=aws_ecr_repository.frontend \
            -var="db_user=${{ secrets.DB_USER }}" \
            -var="db_pass=${{ secrets.DB_PASS }}" \
            -var="region=${{ env.AWS_REGION }}"

      - name: Get ECR URIs
        id: ecr
        working-directory: terraform
        run: |
          echo "backend_uri=$(terraform output -raw ecr_backend_uri)" >> $GITHUB_OUTPUT
          echo "frontend_uri=$(terraform output -raw ecr_frontend_uri)" >> $GITHUB_OUTPUT

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push backend
        run: |
          docker build -t backend ./backend
          docker tag backend:latest ${{ steps.ecr.outputs.backend_uri }}:latest
          docker push ${{ steps.ecr.outputs.backend_uri }}:latest

      - name: Build & push frontend
        run: |
          docker build -t frontend ./frontend
          docker tag frontend:latest ${{ steps.ecr.outputs.frontend_uri }}:latest
          docker push ${{ steps.ecr.outputs.frontend_uri }}:latest

      # - name: Terraform deploy
      #   working-directory: terraform
      #   run: |
      #     terraform apply -auto-approve \
      #       -var="backend_image=${{ steps.ecr.outputs.backend_uri }}:latest" \
      #       -var="frontend_image=${{ steps.ecr.outputs.frontend_uri }}:latest" \
      #       -var="db_user=${{ secrets.DB_USER }}" \
      #       -var="db_pass=${{ secrets.DB_PASS }}" \
      #       -var="region=${{ env.AWS_REGION }}"
